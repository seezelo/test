<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Naver Directions Final</title>

<style>
  body { margin:0; font-family:sans-serif; }
  #topbar { padding:10px; background:#f5f5f5; }
  #map { width:100%; height:500px; }
  #info { padding:8px; white-space:pre-wrap; }
  button { padding:6px 10px; margin-right:6px; }
</style>

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=8vgpjrgiyy"></script>
</head>

<body>
<div id="topbar">
  ì§€ë„ í´ë¦­ â†’ ì¶œë°œ â†’ ê²½ìœ  â†’ ë„ì°© ìˆœì„œ
  <button onclick="resetAll()">ì´ˆê¸°í™”</button>
  <button onclick="findRoute()">ê²½ë¡œì°¾ê¸°</button>
</div>

<div id="map"></div>
<div id="info">ëŒ€ê¸° ì¤‘</div>

<script>
let map;
let points = [];
let markers = [];
let polyline = null;

map = new naver.maps.Map("map", {
  center: new naver.maps.LatLng(37.5665, 126.9780),
  zoom: 12
});

naver.maps.Event.addListener(map, "click", e => {
  if (points.length >= 3) {
    alert("ì¶œë°œ/ê²½ìœ /ë„ì°© 3ê°œê¹Œì§€ë§Œ");
    return;
  }
  const lat = e.coord.lat();
  const lng = e.coord.lng();
  points.push(`${lng},${lat}`);

  const colors = ["green","blue","red"];
  const marker = new naver.maps.Marker({
    position: e.coord,
    map,
    icon: {
      content:`<div style="width:14px;height:14px;background:${colors[points.length-1]};border-radius:50%"></div>`
    }
  });
  markers.push(marker);
});

async function findRoute() {
  if (points.length < 2) {
    alert("ì¶œë°œê³¼ ë„ì°© í•„ìš”");
    return;
  }

  const start = points[0];
  const goal = points[points.length - 1];
  const waypoints = points.length === 3 ? points[1] : "";

  const infoEl = document.getElementById("info");
  infoEl.innerText = "ê²½ë¡œ ê³„ì‚° ì¤‘...";

  try {
    const res = await fetch(`/api/directions?start=${start}&goal=${goal}&waypoints=${waypoints}`);
    const text = await res.text();
    console.log("STATUS:", res.status);
    console.log("RAW:", text);

    let data;
    try {
      data = JSON.parse(text);
    } catch {
      throw new Error("ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë°˜í™˜");
    }

    // âœ… ë„¤ì´ë²„ ì—ëŸ¬ë¥¼ ì‚¬ëŒë§ë¡œ ë³´ì—¬ì£¼ê¸°
    if (data?.error) {
      const code = data.error.errorCode;
      const msg = data.error.message;
      const details = data.error.details || "";
      infoEl.innerText =
        `âŒ NAVER API ì˜¤ë¥˜\n` +
        `code: ${code}\n` +
        `message: ${msg}\n` +
        `details: ${details}\n\n` +
        `ğŸ‘‰ NCP ì½˜ì†”ì—ì„œ Directions 15 êµ¬ë…(Subscription) + ì•±ì—ì„œ API ì²´í¬ í•„ìš”`;
      return;
    }

    if (!data.route?.trafast?.[0]) {
      infoEl.innerText = "âŒ ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const route = data.route.trafast[0];

    if (polyline) polyline.setMap(null);

    const path = route.path.map(p => new naver.maps.LatLng(p[1], p[0]));

    polyline = new naver.maps.Polyline({
      map,
      path,
      strokeColor:"#007AFF",
      strokeWeight:6
    });

    const min = Math.floor(route.summary.duration / 60000);
    const km = (route.summary.distance / 1000).toFixed(1);
    infoEl.innerText = `âœ… ì„±ê³µ\nâ± ${min}ë¶„\nğŸ“ ${km}km`;

  } catch (err) {
    console.error(err);
    infoEl.innerText = "âŒ ê²½ë¡œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)";
  }
}

function resetAll() {
  markers.forEach(m => m.setMap(null));
  markers = [];
  points = [];
  if (polyline) polyline.setMap(null);
  polyline = null;
  document.getElementById("info").innerText = "ì´ˆê¸°í™” ì™„ë£Œ";
}
</script>
</body>
</html>
